#
# Chakra Packages for Chakra, part of chakra-project.org
#
# maintainer (i686): Phil Miller <philm[at]chakra-project[dog]org>
# maintainer (x86_64): Manuel Tortosa <manutortosa[at]chakra-project[dot]org>

# include global config
source ../_buildscripts/${current_repo}-${_arch}-cfg.conf


#
# package info
#
pkgname=tribe
pkgver=0.2.1
_sver=20100905
pkgrel=2
pkgdesc="Tribe - Chakra LiveCD Installer"
url="http://git.chakra-project.org/chakra/"
license="GPL"
arch=('i686' 'x86_64')
depends=('kdelibs' 'kdeedu-marble>=4.4.5' 'squashfs-tools' "tribe-partitionmanager>=0.2.1")
makedepends=('cmake' 'kdelibs' 'kdeedu-marble>=4.4.5' 'kdebase-workspace')
provides=('tribe')
replaces=('kdemod-tribe-svn' 'kdemod-tribe')
conflicts=('chakra-tribe' 'tribe-svn' 'kdemod-partitionmanager' 'kdemod-tribe' 'kdemod-tribe-debug' 'kdemod-tribe-partitionmanager')
options=('!splithdr' '!splitdbg')
source=("http://chakra-project.org/sources/tribe/tribe-${pkgver}.tar.xz"
        "http://chakra-project.org/sources/tribe/tribe-screenshots-${_sver}.tar.gz"
        "http://chakra-project.org/sources/tribe/bundle-sys.patch"
        "http://chakra-project.org/sources/tribe/slideshow-timer.patch")
md5sums=('a91a8195a6fd5c4f5e659fa05448d507'
         '94779efc8bd491dfe3eaf39d022b8354'
         'b4140b2d2bdc0f55f10a7b1903b4ae0c'
         '8bdc12ee4b17ced5f1a4a6731b534c18')

groups=('kde-uninstall')
install=tools-tribe.install

#
# build function
#
build()
{
        cd "${srcdir}"
        msg "add postfix patches"
        patch -Np1 -i ${srcdir}/bundle-sys.patch || return 1
        patch -Np1 -i ${srcdir}/slideshow-timer.patch || return 1

        cd "${srcdir}/$pkgname"

	msg "replace screenshots"
	cp -vr "${srcdir}/tribe-screenshots-${_sver}/images/" "${srcdir}/$pkgname/ui"

	# add pkgver to tribe
	sed -i -e "s~source build/from git~Build: ${pkgver}-${pkgrel} (Chakra)~g" config-tribe.h.cmake
	# fix theme
	sed -i -e "s~ashoc~crunchy-branch-blue~g" "${srcdir}/$pkgname/etc/postinstall-functions/job-configure-users"
	sed -i -e "s~ashoc~crunchy-branch-blue~g" "${srcdir}/$pkgname/etc/postinstall-functions/job-initialize-target"
	sed -i -e "s~0.2.831~${pkgver}~g" "${srcdir}/$pkgname/etc/postinstall-functions/job-initialize-target"
	cmake . -DCMAKE_INSTALL_PREFIX=${_installprefix} \
		-DCMAKE_BUILD_TYPE=${_build_type} \
		-DCMAKE_SKIP_RPATH=ON \
		-DCMAKE_{SHARED,MODULE,EXE}_LINKER_FLAGS='-Wl,--no-undefined -Wl,--as-needed' || return 1

	msg "Starting make..."
	make || return 1

	msg "Make successful, installing..."
	make DESTDIR=$startdir/pkg install || return 1

	# remove nasty files
	find $startdir/pkg/ -name ".git" -type d -exec rm -fr {} +
	
	# remove release announcement
	rm $startdir/pkg/usr/share/tribe/config/release_notes.txt
}