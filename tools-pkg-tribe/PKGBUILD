#
# Chakra Packages for Chakra, part of chakra-project.org
#
# maintainer (i686): Phil Miller <philm[at]chakra-project[dog]org>
# maintainer (x86_64): Manuel Tortosa <manutortosa[at]chakra-project[dot]org>

#
# package info
#
pkgname=tribe
pkgver=2011.04
pkgrel=ms3
_codename=Aida
pkgdesc="Tribe - Chakra LiveCD Installer"
url="http://git.chakra-project.org/chakra/"
license="GPL"
arch=('i686' 'x86_64')
depends=('kdelibs' 'kdeedu-marble>=4.6.1' 'squashfs-tools' 'partitionmanager>=1216949-2'
        'cinstall>=0.4.1' 'rsync' 'mkinitcpio-nfs-utils' 'ntfsprogs')
makedepends=('cmake' 'kdelibs' 'kdeedu-marble>=4.6.1' 'kdebase-workspace')
provides=('tribe')
replaces=('kdemod-tribe-svn' 'kdemod-tribe')
conflicts=('chakra-tribe' 'tribe-svn' 'kdemod-partitionmanager' 'kdemod-tribe' 'kdemod-tribe-debug' 'kdemod-tribe-partitionmanager')
options=('!splithdr' '!splitdbg' 'sign')
source=("http://chakra-project.org/sources/tribe/tribe-${pkgver}-${pkgrel}.tar.xz"
        "http://chakra-project.org/sources/tribe/RELEASE_NOTES_201104MS3.html"
        "http://chakra-project.org/sources/tribe/configPageBundleData-i686"
        "http://chakra-project.org/sources/tribe/configPageBundleData-x86_64")
  
md5sums=('5ee30ed75498be1edb0b8e0aafcf6add'
         'e35cc70e87250559edfe952e46b6b994'
         'd8a2440c030405a4be214fc0c8995640'
         '99b99d7454dbd1c2fcbbd6830928cab2')
         
groups=('kde-uninstall')
install=tools-tribe.install

# create tarball: source PKGBUILD && mksource

mksource() {
	  rm -vRf tribe
	  git clone git://gitorious.org/chakra/tribe.git
	  cd ${pkgname}
	  git checkout 2011.03
	  cd ..
	  rm -vRf tribe/.git
	  pushd ${pkgname}
	  popd
	  tar -cvJf ${pkgname}-${pkgver}-${pkgrel}.tar.xz ${pkgname}/*
	  md5sum ${pkgname}-${pkgver}-${pkgrel}.tar.xz
}

#
# build function
#
build()
{
        cd "${srcdir}/$pkgname"

	# workaround for bug https://bugzilla.novell.com/show_bug.cgi?id=656144
	sed -i -e "s~sudo~kdesu~g" "${srcdir}/$pkgname/tribe.desktop"
	# workaround for bundles issue
	cp -v ${srcdir}/configPageBundleData-$arch ${srcdir}/$pkgname/data/configPageBundleData

	# patches
	#patch -Np1 -i ${srcdir}/oops.patch || return 1
	#patch -Np1 -i ${startdir}/2011.03-1.patch || return 1

	# remove unsupported pkgs for x64
	if [ "${CARCH}" = "x86_64" ]; then
	    rm -v ${srcdir}/$pkgname/data/appIcons/wine.png
	    rm -v ${srcdir}/$pkgname/data/appIcons/skype.png
	    sed -i -e '/wine/d' ${srcdir}/$pkgname/data/configPagePkgData
	    sed -i -e '/skype/d' ${srcdir}/$pkgname/data/configPagePkgData
	fi

	# add pkgver to tribe
	sed -i -e "s~source build/from git~Build: ${pkgver} ($_codename)~g" config-tribe.h.cmake
	sed -i -e "s~git-checkout~${pkgver}-${pkgrel}~g" "${srcdir}/$pkgname/scripts/postinstall-functions/job-initialize-target"
	cmake . -DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_SKIP_RPATH=ON \
		-DCMAKE_{SHARED,MODULE,EXE}_LINKER_FLAGS='-Wl,--no-undefined -Wl,--as-needed' || return 1

	msg "Starting make..."
	make || return 1
}

package()
{
        cd "${srcdir}/$pkgname"
	msg "Make successful, installing..."
	make DESTDIR=$startdir/pkg install || return 1
	cp -vf ${srcdir}/RELEASE_NOTES_201104MS3.html $pkgdir/usr/share/tribe/config/RELEASE_NOTES.html

	# remove nasty files
	find $startdir/pkg/ -name ".git" -type d -exec rm -fr {} +
}