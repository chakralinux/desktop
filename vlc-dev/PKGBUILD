#
# Chakra Packages for Chakra, part of chakra-project.org
#
# maintainer (i686): Phil Miller <philm[at]chakra-project[dog]org>
# maintainer (x86_64): Manuel Tortosa <manutortosa[at]chakra-project[dot]org>

# PKGBUILD based on: http://aur.archlinux.org/packages.php?ID=26800

# include global config
source ../_buildscripts/${current_repo}-${_arch}-cfg.conf

pkgname=vlc-dev
pkgver=1.1.0rc1
_dlver=1.1.0-rc
pkgrel=1
pkgdesc="A multi-platform MPEG, VCD/DVD, and DivX player with VAAPI support"
arch=('i686' 'x86_64')
url="http://www.videolan.org/vlc/"
license=(GPL)

# NOTE: Here you choose whether or not to enable all the VAAPI stuff (GPU acceleration for video processing - which is faster).
# But with VLC this is still experimental (like this whole bleeding edge version of VLC). Thus, if for any reason you want to
# disable VAAPI, just set the value of the following variable to anything else than "1". You can also comment the variable itself,
# modify it or just remove it completely.  We call this the 'Freedom of choice' down here.
_vaapi=1

makedepends=('libnotify' 'libxpm' 'lirc-utils' 'live-media' 'xulrunner')
    optdepends=('libdvdcss: for decoding encrypted DVDs'
		'libnotify: for notification plugin'
		'lirc-utils: for lirc plugin')
if [ "$_vaapi" == "1" ]; then
  depends=('a52dec' 'avahi' 'ffmpeg' 'fribidi' 'fluidsynth' 'libass' 'libcddb'
	   'libcdio' 'libdca' 'libdvbpsi' 'libdvdnav' 'libmad' 'libmatroska'
	   'libmodplug' 'libmpcdec' 'libmpeg2' 'libmtp' 'libproxy' 'libshout'
	   'libv4l' 'libva-sds' 'libxv' 'lua' 'mesa' 'qt' 'sdl_image' 'smbclient'
	   'sysfsutils' 'taglib' 'ttf-freefont' 'vdpau-video' 'xdg-utils' 'zvbi')
else # 'libva-sds' and 'vdpau-video' won't be installed, if "_vaapi" variable not set as "1"
  depends=('a52dec' 'avahi' 'ffmpeg' 'fribidi' 'fluidsynth' 'libass' 'libcddb'
	   'libcdio' 'libdca' 'libdvbpsi' 'libdvdnav' 'libmad' 'libmatroska'
	   'libmodplug' 'libmpcdec' 'libmpeg2' 'libmtp' 'libproxy' 'libshout'
	   'libv4l' 'libxv' 'lua' 'mesa' 'qt' 'sdl_image' 'smbclient' 'sysfsutils'
	   'taglib' 'ttf-freefont' 'xdg-utils' 'zvbi')
fi
replaces=('vlc')
conflicts=('vlc')
provides=('vlc')
options=(!libtool)
install=vlc.install
source=(http://downloads.videolan.org/pub/videolan/testing/vlc-${_dlver}/vlc-${_dlver}.tar.bz2
        vlc-vdpau.desktop)
md5sums=('4983cbcaf206392c8fa7df6608fdf1ef'
         'b58ffb8c14b6967685a08c1d5332e190')

build() {
  # fix build
  if [ "${_arch}" = "i686" ]; then
    export CXXFLAGS="-march=i686 -mtune=generic -O2 -pipe -D__STDC_CONSTANT_MACROS"
  else
    export CXXFLAGS="-march=x86-64 -mtune=generic -O2 -pipe -D__STDC_CONSTANT_MACROS"
  fi

  cd $startdir/src/vlc-${_dlver}
sed -i -e 's:truetype/freefont:TTF:g' modules/misc/freetype.c
  [ "${CARCH}" = "i686" ] && EXTRAFEATURES="--enable-loader --enable-live555 --with-live555-tree=/usr/lib/live"
  [ "${CARCH}" = "x86_64" ] && EXTRAFEATURES="--enable-fast-install --enable-live555 --with-live555-tree=/usr/lib/live"
  ./configure --prefix=/usr \
	      --enable-libass \
	      --enable-dvdread \
	      --enable-jack \
	      --enable-dvdnav \
	      --disable-rpath \
	      --enable-zvbi \
	      --enable-qt4 \
	      --enable-faad \
	      --enable-alsa \
	      --enable-skins2 \
	      --enable-dvb \
	      --enable-v4l \
	      --enable-theora \
	      --enable-flac \
	      --enable-snapshot \
	      --enable-dbus \
	      --enable-ogg \
	      --enable-dbus-control \
	      --enable-shared \
	      --enable-nls \
	      --enable-lirc \
	      --enable-shout \
	      --enable-pvr \
	      --enable-ncurses \
	      --enable-mozilla \
	      --enable-merge-ffmpeg \
	      --disable-projectm \
	      --program-suffix= \
	      --enable-realrtsp ${EXTRAFEATURES} || return 1
  CFLAGS="-fPIC"
  make || return 1
  make DESTDIR=${pkgdir}/ install || return 1

  for res in 16 32 48 128; do
    install -D -m644 ${srcdir}/vlc-${_dlver}/share/vlc${res}x${res}.png \
	      ${pkgdir}/usr/share/icons/hicolor/${res}x${res}/apps/vlc.png || return 1
  done

      #Enabling hardware acceleration option in the .desktop file
      install -D -m 644 ${srcdir}/vlc-vdpau.desktop ${pkgdir}/usr/share/applications/vlc-vdpau.desktop

  rm -rf ${pkgdir}/usr/lib/mozilla
}