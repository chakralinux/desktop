#
# Chakra Packages for Chakra, part of chakra-project.org
#
# maintainer (i686): Phil Miller <philm[at]chakra-project[dog]org>
# maintainer (x86_64): Manuel Tortosa <manutortosa[at]chakra-project[dot]org>

# include global config
source ../_buildscripts/${current_repo}-${_arch}-cfg.conf


#
# package info
#
pkgbase=('networkmanagement')
# totally broken
pkgname=('networkmanagement-networkmanager-plasmoid'
	 'networkmanagement-knetworkmanager-kde4')
         
arch=('i686' 'x86_64')
pkgver=1129051
#pkgver=1030904 # stable snapshot
pkgrel=1

pkgdesc="split package"
url="http://plasma.kde.org"
license=('GPL')

options=('force')

depends=("kdelibs>=${_kdever}" "kdebase-workspace>=${_kdever}" 'networkmanager>=0.7.999')
makedepends=('subversion' 'cmake' 'python' 'automoc4')

# comment out when using stable snapshot
_svntrunk=svn://anonsvn.kde.org/home/kde/trunk/kdereview/networkmanagement
_svnmod=networkmanagement


#
# build function
#
build() {
cd "$srcdir"

	# comment out when using stable snapshot
	svn co $_svntrunk $_svnmod --revision $pkgver
	#svn co svn://anonsvn.kde.org/home/kde/trunk/kdereview/networkmanagement --revision $pkgver
	msg "SVN checkout done or server timeout"

	mkdir -p $srcdir/build
	mkdir -p $srcdir/split
	cd $srcdir/build
	
	cmake ../networkmanagement -DCMAKE_INSTALL_PREFIX=${_installprefix} \
			  -DDBUS_SYSTEM_POLICY_DIR=/etc/dbus-1/system.d \
			  -DCMAKE_BUILD_TYPE=${_build_type} \
			  -DCMAKE_SKIP_RPATH=ON \
			  -DCMAKE_{SHARED,MODULE,EXE}_LINKER_FLAGS='-Wl,--no-undefined -Wl,--as-needed'
	make || return 1
	
	make DESTDIR=$srcdir/split install || return 1

	# workaround remove plasmoid files
	#cd $srcdir/split
	#rm -v usr/lib/kde4/plasma_applet_networkmanagement.so
	#rm -v usr/share/kde4/services/plasma-applet-networkmanagement.desktop
}

#
# split-install functions
#
package_networkmanagement-networkmanager-plasmoid()
{
	pkgdesc="A NetworkManager plasmoid for KDE4"
	depends=("networkmanagement-knetworkmanager-kde4=${pkgver}")
	conflicts=('networkmanager-plasmoid-svn' 'networkmanager-plasmoid' 'playground-plasmoid-networkmanager-svn')
	groups=("kde-uninstall")

	#collect package
	cd $srcdir/split
	mkdir -p ${pkgdir}/usr/lib/kde4
	mkdir -p ${pkgdir}/usr/share/kde4/services
	mv -v usr/lib/kde4/plasma_applet_networkmanagement.so ${pkgdir}/usr/lib/kde4/plasma_applet_networkmanagement.so
	mv -v usr/share/kde4/services/plasma-applet-networkmanagement.desktop ${pkgdir}/usr/share/kde4/services/plasma-applet-networkmanagement.desktop
}

package_networkmanagement-knetworkmanager-kde4()
{
	pkgdesc="KNetworkManager for KDE4"
	depends=("kdelibs>=${_kdever}" "kdebase-workspace>=${_kdever}" 'networkmanager>=0.8')
	provides=("knetworkmanager-kde4=${pkgver}")
	conflicts=('networkmanager-plasmoid-svn' 'networkmanager-plasmoid' 'playground-plasmoid-networkmanager-svn')
	groups=("kde" "kde-complete" "networkmanagement" "kde-uninstall")

	#collect package
	cd $srcdir/split
	cp -Rv  * ${pkgdir}
}
