#
# Games Packages for Chakra, part of chakra-project.org
#
# Maintainer: Adrian Chaves Fernandez (Gallaecio) <adriyetichaves gmail.com>

pkgname=supertuxkart
_pkgname=SuperTuxKart
pkgver=0.8.1
pkgrel=1
pkgdesc="Kart racing game featuring Tux and friends."
url="http://supertuxkart.sourceforge.net/"
arch=('x86_64')
license=('GPL3' 'GPL2' 'CCPL-by' 'CCPL-by-sa' 'custom:Public Domain')
depends=('bullet' 'bzip2' 'curl' 'enet' 'fribidi' 'freeglut' 'irrlicht' 'libgl' 'libjpeg' 'libogg' 'libpng' 'libvorbis' 'openal' 'wiiuse')
conflicts=('supertuxkart-svn')
categories=('games')
changelog=ChangeLog
source=("http://downloads.sourceforge.net/project/${pkgname}/${_pkgname}/${pkgver}/${pkgname}-${pkgver}-src.tar.bz2"
        "$pkgname-system-libs.diff"
        "FindEnet.cmake"
        "FindIrrlicht.cmake"
        "FindWiiUse.cmake")
md5sums=('aa31ecf883dc35859eec76c667f1a6d6'
         '0b45cd22405166e2d6a342162a20d482'
         'f63b2d5fbac6c53699aaaf97ed7f89d6'
         '78735ca4da9c04422a09f385561f5d9d'
         'b23cdd616cb27e2c114bbb1e3840274c')

build() {
  cd "${srcdir}/${_pkgname}-${pkgver}"
  
  # Patches.
  
    # For using system libraries.
    patch -uN CMakeLists.txt $srcdir/$pkgname-system-libs.diff
    sed -e "s#wiiuse/wiiuse.h#wiiuse.h#" -i src/input/wiimote_manager.cpp
    cp $srcdir/*.cmake cmake/
  
  mkdir -p build && cd build
  cmake \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DUSE_WIIUSE=ON \
    -DUSE_FRIBIDI=ON \
    ..
  make
}

package() {
  cd "${srcdir}/${_pkgname}-${pkgver}/build"
  
  make DESTDIR="${pkgdir}" install
  
  # Desktop Integration
  sed -e "s@/usr/games@/usr/bin@" -i $pkgdir/usr/share/applications/$pkgname.desktop

  # Licensing
  install -d "${pkgdir}/usr/share/licenses/${pkgname}"
  ln -s "${pkgdir}/usr/share/games/${pkgname}/data/CREDITS" "${pkgdir}/usr/share/licenses/${pkgname}/AUTHORS"
  cp "${srcdir}/${_pkgname}-$pkgver/COPYING" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
md5sums=('aa31ecf883dc35859eec76c667f1a6d6'
         '782d4f79b0ee7d6c276a06930c70e93e'
         'f63b2d5fbac6c53699aaaf97ed7f89d6'
         '78735ca4da9c04422a09f385561f5d9d'
         'b23cdd616cb27e2c114bbb1e3840274c')
