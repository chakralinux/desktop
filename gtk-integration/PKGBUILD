#
# Packages for Chakra, part of chakra-project.org
#
# maintainer (i686): Phil Miller <philm[at]chakra-project[dog]org>
# maintainer (x86_64): Manuel Tortosa <manutortosa[at]chakra-project[dot]org>

# include global config
source ../_buildscripts/${current_repo}-${_arch}-cfg.conf

pkgname=gtk-integration
pkgver=1.4
pkgrel=1
iconspkgver=2.5.0
widgetpkgver=0.7.7
chthemever=0.3.1
_colors=3.0

pkgdesc="A bundles and gtk apps integration package for Chakra GNU/Linux"
arch=('i686' 'x86_64')

url=("http://www.nanolx.org/home/item/75-oxygen-refit"
     "http://kde-look.org/content/show.php/gtk-oxygen-engine?content=129715"
     "http://plasmasturm.org/programs/gtk-chtheme/"
     "http://code.google.com/p/princeamds-code/")

license=('LGPL3' 'GPL')

depends=('kdelibs' 'qt' 'oxygen-icons' 'python2' 'gtk2' 'pygtk')
makedepends=('gcc' 'cmake' 'findutils' 'imagemagick' 'liblqr')
provides=('gtk-integration' 'oxygenrefit2-icon-theme' 'gtk-oxygen-engine' 'gtk-chtheme' 'gtk-icon-theme-changer')
conflicts=('oxygenrefit2-icon-theme' 'gtk-oxygen-engine' 'gtk-oxygen-engine-git' 'gtk-chtheme' 'gtk-icon-theme-changer')

source=("http://download.tuxfamily.org/oxygenrefit2/oxygen-refit-2-$iconspkgver.tar.bz2"
        "http://kde-look.org/CONTENT/content-files/129715-gtk-oxygen-engine-$widgetpkgver.tgz"
	"http://plasmasturm.org/programs/gtk-chtheme/gtk-chtheme-$chthemever.tar.bz2"
	"http://chakra-project.org/sources/gtk-integration/gtk-icon-theme-changer.tar.gz")
md5sums=('60f32f98d8d33d82db79b6bb934f0580'
	 'bc034cd906d67bc461e5fcb19971aff2'
         'f688053bf26dd6c4f1cd0bf2ee33de2a'
         'fb9519061e9cf26577d34b02171c256b')

function create_install() {
cat > "${startdir}/${pkgname}.install" <<EOF
post_install() {
	cat <<-'EOF'

		#   GTK - Integration v$pkgver-$pkgrel
		#  
		#   If you want GTK+ apps or bundles run with root privileges to be themed as well
		#   copy your \`~/.gtkrc-2.0-kde4' file to \`/root/gtkrc-2.0'
		#
		#   sudo cp ~/.gtkrc-2.0-kde4 /root/.gtkrc-2.0

	EOF
}

post_upgrade() {
	post_install \$1
}

op=\$1
shift
\$op \$*
EOF
}

function build() {
	# Icon theme
	cd ${srcdir}
	install -d ${pkgdir}/usr/share/icons/
	cp -rf "oxygen-refit-2-${iconspkgver}" ${pkgdir}/usr/share/icons/ || return 1
	mv "oxygen-refit-2-${iconspkgver}" "oxygen-refit-2"
	find -type f -print0 | xargs -0 chmod 644

        # Widget theme
	cd $srcdir/gtk-oxygen-engine-$widgetpkgver
	rm -rf build
	mkdir build && cd build
	cmake -DCMAKE_BUILD_TYPE=Release \
	-DCMAKE_SKIP_RPATH=ON \
	-DCMAKE_INSTALL_PREFIX=/usr .. || return 1
	make || return 1
	make DESTDIR=${pkgdir} install

	# Gtk-ChTheme
	cd ${srcdir}/gtk-chtheme-$chthemever
        sed -i 's|-DGTK.*||' Makefile
        sed -i 's|theme_list(g_.*|&\n\tread_theme_list(g_strconcat(g_get_user_data_dir(), "/themes", NULL));|' main.c
        make || return 1
	install -Dm755 gtk-chtheme ${pkgdir}/usr/bin/gtk-chtheme || return 1
	
	#Gtk-Icon-Theme-Changer
	cd ${srcdir}
	cp -a gtk-icon-theme-changer/gtk-icon-themes.py ${pkgdir}/usr/bin/gtk-icon-theme-changer
	chmod -R 755 "$pkgdir"
}

function package() {
	# Additional desktop files
	cd ${startdir}
	install -Dm 644 gtk-chtheme.desktop ${pkgdir}/usr/share/applications/gtk-chtheme.desktop || return 1
	install -Dm 644 gtk-icon-theme-changer.desktop ${pkgdir}/usr/share/applications/gtk-icon-theme-changer.desktop || return 1

	# Create the install file
	create_install
	export install="${pkgname}.install"
}


