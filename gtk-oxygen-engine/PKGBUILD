pkgname=gtk-oxygen-engine
pkgver=0.7.7
pkgrel=1
chthemever=0.3.1

pkgdesc="A GTK engine matching Oxygen Kde style"
arch=('i686' 'x86_64')

url="http://kde-look.org/content/show.php/gtk-oxygen-engine?content=129715 / http://plasmasturm.org/programs/gtk-chtheme/"
license=('GPL')

depends=('kdelibs>=4.4.0' 'qt>=4.6')
makedepends=('gcc' 'cmake' 'gtk2')
provides=('gtk-oxygen-engine' 'gtk-chtheme')
conflicts=('gtk-integration')
replaces=('oxygenrefit2-icon-theme' 'oxygen-molecule-theme' 'gtk-chtheme')

source=("http://kde-look.org/CONTENT/content-files/129715-gtk-oxygen-engine-$pkgver.tgz"
	"http://plasmasturm.org/programs/gtk-chtheme/gtk-chtheme-$chthemever.tar.bz2")
md5sums=('bc034cd906d67bc461e5fcb19971aff2'
	 'f688053bf26dd6c4f1cd0bf2ee33de2a')


function create_install() {
cat > "${startdir}/${pkgname}.install" <<EOF
post_install() {
	cat <<-'EOF'
		
		##################################################################################
		#
		#   GTK - Integration v$pkgver-$pkgrel
		#  
		#   If you want GTK+ apps or bundles run with root privileges to be themed as well
		#   copy your \`~/.gtkrc-2.0-kde4' file to \`/root/gtkrc-2.0'
		#
		#   sudo cp ~/.gtkrc-2.0-kde4 /root/.gtkrc-2.0
		#
		#   You may apply the Oxygen-Molecule color scheme to your KDE apps by going to
		#   \`System Settings -> Appearance -> Colors' and selecting the OxygenMolecule.
		#
		#  Also, to make sure your GTK apps use only the Oxygen Molecule color scheme,
		#  navigate to \`System Settings -> Appearance -> Colors -> Options (tab)' and
		#  uncheck the "Apply colors to non-KDE4 applications" option.
		
	EOF
}

post_upgrade() {
	post_install \$1
}

op=\$1
shift
\$op \$*
EOF
}


function build() {

      cd $srcdir/$pkgname-$pkgver
      rm -rf build
      mkdir build && cd build
      cmake -DCMAKE_BUILD_TYPE=Release \
	    -DCMAKE_SKIP_RPATH=ON \
	    -DCMAKE_INSTALL_PREFIX=/usr .. || return 1
      make || return 1
      make DESTDIR=${pkgdir} install

      # Gtk-ChTheme
      cd ${srcdir}/gtk-chtheme-$chthemever
      # Fix xdg compliancy
      sed -i 's|-DGTK.*||' Makefile
      sed -i 's|theme_list(g_.*|&\n\tread_theme_list(g_strconcat(g_get_user_data_dir(), "/themes", NULL));|' main.c
      make || return 1
      mkdir -p "${pkgdir}/usr/bin"
      install -m 755 gtk-chtheme "${pkgdir}/usr/bin/" || return 1

      cd ${startdir}
      install -Dm 644 gtk-chtheme.desktop ${pkgdir}/usr/share/applications/gtk-chtheme.desktop || return 1
      create_install
      export install="${pkgname}.install"
}
