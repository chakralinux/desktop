#
# Chakra Packages for Chakra, part of chakra-project.org
#
# maintainer (x86_64): Manuel Tortosa <manutortosa[at]chakra-project[dot]org>
# contributor (x86_64): AlmAck <gluca86[at]google[dot]com>

pkgname=backintime-kde
pkgver=1.0.26
_bzrversion=876
pkgrel=3
pkgdesc="Back In Time is a simple backup system for Linux inspired from 'flyback project' and 'TimeVault'. KDE 4 version"
arch=('x86_64')
url="https://launchpad.net/backintime"
license="GPL"
depends=('rsync' 'cron' 'python' 'xorg-utils' 'pyqt' 'kdebindings-python2' 'python2-keyring')
source=("http://backintime.le-web.org/wp-content/uploads/2009/03/backintime-$pkgver.tar.gz"
        'fix_spaces_in_anacron_jobs.patch'
	'fix_AttributeError_with_python-keyring_gt1.6.1.patch'
	'fix_kde4.patch')
md5sums=('76f6fb5f44e04866fd7667f522f6b3d4'
         'caa9f7dcdc16442e4f0a4ef28e84f36b'
         '2c9bcab4a90f1e5d58773f8ca6912b8e'
         'e3775996c91584d10aacb3fb2f13fb62')
makedepends=('bzr')
categories=('utils' 'backup')

_bzrbranch=lp:backintime 
_bzrmod=trunk

prepare() {
  patch -Np1 -i "${srcdir}/fix_spaces_in_anacron_jobs.patch"
  patch -Np1 -i "${srcdir}/fix_kde4.patch"
  patch -Np1 -i "${srcdir}/fix_AttributeError_with_python-keyring_gt1.6.1.patch"
}

build() {

  msg "Connecting to the server...."
  cd ${srcdir}

  if [[ -d "$_bzrmod" ]]; then
    cd "$_bzrmod" && bzr pull "$_bzrbranch" -r "$_bzrversion"
    msg "The local files are updated."
  else
    #bzr branch "$_bzrbranch" -q -r "$_bzrversion"
    bzr branch ${_bzrbranch} ${_bzrmod} -q -r ${_bzrversion}
  fi
 
  msg "BZR checkout done or server timeout"
  msg "Starting make..."
  
  cd $srcdir/$_bzrmod/common
  ./configure
  make || return 1

  cd $srcdir/$_bzrmod/kde4
  ./configure
  make || return 1
}

package(){
  cd $srcdir/$_bzrmod/common
  make DESTDIR=${pkgdir} install || return 1
  sed -i -e 's/python/python2/g' ${pkgdir}/usr/bin/backintime
  
  cd $srcdir/$_bzrmod/kde4
  make DESTDIR=${pkgdir} install || return 1
  sed -i -e 's/python/python2/g' ${pkgdir}/usr/bin/backintime-kde4
}
