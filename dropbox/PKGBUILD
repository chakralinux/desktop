pkgname=dropbox
pkgver=3.4.6
pkgrel=1
pkgdesc="A free service that lets you bring your photos, docs, and videos anywhere and share them easily."
arch=('x86_64')
url="http://www.dropbox.com"
license=('custom')
depends=('dbus-glib' 'libsm')
optdepends=(
    'dropbox-servicemenu: servicemenu for KDE4'
)
provides=('kfilebox')
conflicts=('kfilebox')
replaces=('kfilebox')
options=('!strip' '!upx')
source=("https://dl-web.dropbox.com/u/17/${pkgname}-lnx.${arch}-${pkgver}.tar.gz"
        "dropbox.png"
        "dropbox.desktop"
        "terms.txt"
        "dropbox@.service")
md5sums=('0b77dcdaece4b17a8a16cce50c66869a'
         '2be5a57e477adf82a7d9b7fe77f22086'
         '20c97082211cf02af494043b93d5feb8'
         'c5805dbc29e952f21c83230aa725d5b0'
         '9ab7095c79d4ae550ab798afeee0683f')
install="${pkgname}.install"

package() {
	install -d "$pkgdir/opt"
	cp -R "$srcdir"/.dropbox-dist/dropbox-lnx.$arch-$pkgver "$pkgdir"/opt/dropbox
 
	find "$pkgdir/opt/dropbox/" -type f -exec chmod 644 {} \;
	find "$pkgdir/opt/dropbox/" -type d -exec chmod 755 {} \;
	chmod 755 "$pkgdir/opt/dropbox/dropboxd"
	chmod 755 "$pkgdir/opt/dropbox/dropbox"
	chown -R root:root "$pkgdir/opt/dropbox"
 
	install -d "$pkgdir/usr/bin"
	ln -s "/opt/dropbox/dropboxd" "$pkgdir/usr/bin/dropboxd"
 
	install -D -m 644 "$srcdir/dropbox.desktop" "$pkgdir/usr/share/applications/dropbox.desktop"
	install -D -m 644 "$srcdir/dropbox.png" "$pkgdir/usr/share/pixmaps/dropbox.png"
	install -D -m 644 "$srcdir/terms.txt" "$pkgdir/usr/share/licenses/$pkgname/terms.txt"
	install -Dm644 "$srcdir/dropbox@.service" "$pkgdir/usr/lib/systemd/system/dropbox@.service"

	rm -f "$pkgdir"/opt/dropbox/library.zip
	ln -s dropbox "$pkgdir"/opt/dropbox/library.zip

        # FIXME: dirty hack to replace Qt5 libs with system ones
        #for i in libQt5Core.so.5 \
        #         libQt5Gui.so.5 \
        #         libQt5OpenGL.so.5 \
        #         libQt5Qml.so.5 \
        #         libQt5Sql.so.5 \
        #         libQt5WebKitWidgets.so.5 \
        #         libQt5DBus.so.5 \
        #         libQt5Network.so.5 \
        #         libQt5PrintSupport.so.5 \
        #         libQt5Quick.so.5 \
        #         libQt5WebKit.so.5 \
        #         libQt5Widgets.so.5 ; do
        #ln -sfv /usr/lib/${i} ${pkgdir}/opt/dropbox/
        #done
}
